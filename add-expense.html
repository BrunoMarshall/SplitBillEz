<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Expense - SplitBillEz</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" href="images/splitbillez_favicon.png">
    <script src="https://cdn.jsdelivr.net/npm/web3@4.16.0/dist/web3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethereum-blockies-base64@0.1.0/dist/ethereum-blockies-base64.min.js"></script>
</head>
<body onload="checkMetaMaskConnection()">
    <header>
        <div class="header-container">
            <img src="images/splitbillez_logo.png" alt="SplitBillEz Logo" class="logo">
            <nav>
                <a href="index.html">Home</a>
                <a href="dashboard.html">Dashboard</a>
                <a href="add-expense.html">Add Expense</a>
            </nav>
            <button class="metamask-button" onclick="handleMetaMaskToggle().then(() => populateGroupDropdown())">Connect with MetaMask</button>
        </div>
    </header>
    <main>
        <section>
            <h2>Add a New Expense</h2>
            <form id="expenseForm">
                <label for="description">Description:</label>
                <input type="text" id="description" placeholder="e.g., Dinner at Restaurant" required>
                <label for="currency">Currency:</label>
                <select id="currency" required>
                    <option value="EUR">EUR</option>
                    <option value="USD">USD</option>
                    <option value="INR">INR</option>
                </select>
                <label for="amount">Amount:</label>
                <input type="number" id="amount" placeholder="e.g., 100" step="0.01" required>
                <p id="shmAmount">SHM Amount: Calculating...</p>
                <label for="split">Split Type:</label>
                <select id="split" required>
                    <option value="equal">Equal</option>
                    <option value="custom">Custom (% shares, sum to 100)</option>
                </select>
                <label for="customShares" id="customLabel" style="display:none;">Custom Shares (%, comma-separated):</label>
                <input type="text" id="customShares" placeholder="e.g., 40,30,30" style="display:none;">
                <label for="groupId">Group:</label>
                <select id="groupId" required>
                    <option value="" disabled selected>Select a group</option>
                </select>
                <div id="groupCreation" style="display:none;">
                    <h3>Create a New Group</h3>
                    <label for="groupName">Group Name:</label>
                    <input type="text" id="groupName" placeholder="e.g., Trip to Goa">
                    <label>Member Addresses:</label>
                    <div id="memberInputs">
                        <div class="member-input">
                            <input type="text" class="member-name" value="Me" readonly>
                            <input type="text" class="member-address" id="userAddress" readonly>
                            <span class="member-label">Your Address</span>
                        </div>
                        <div class="member-input">
                            <input type="text" class="member-name" placeholder="Member Name (e.g., Bob)">
                            <input type="text" class="member-address" placeholder="e.g., 0x742d...">
                            <button type="button" class="remove-member" onclick="removeMember(this)">Remove</button>
                        </div>
                    </div>
                    <button type="button" onclick="addMemberField()">Add Member</button>
                </div>
                <button type="submit" id="submitButton" class="submit-group">Add Expense</button>
                <p id="expenseMessage"></p>
            </form>
        </section>
    </main>
    <footer>
        <p>Â© 2025 SplitBillEz Powered by Shardeum</p>
        <div class="social-links">
            <a href="https://discord.com/invite/shardeum" target="_blank" rel="nofollow">
                <img src="images/discord.svg" alt="Discord" class="social-icon">
            </a>
            <a href="https://github.com/BrunoMarshall/SplitBillEz" target="_blank" rel="nofollow">
                <img src="images/github.svg" alt="GitHub" class="social-icon">
            </a>
            <a href="https://www.linkedin.com/company/shardeum/" target="_blank" rel="nofollow">
                <img src="images/linkedin.svg" alt="LinkedIn" class="social-icon">
            </a>
            <a href="https://t.me/shardeum" target="_blank" rel="nofollow">
                <img src="images/telegram.svg" alt="Telegram" class="social-icon">
            </a>
            <a href="https://x.com/shardeum" target="_blank" rel="nofollow">
                <img src="images/twitter.svg" alt="X" class="social-icon">
            </a>
            <a href="https://www.youtube.com/@shardeum" target="_blank" rel="nofollow">
                <img src="images/youtube.svg" alt="YouTube" class="social-icon">
            </a>
        </div>
    </footer>
    <script src="js/app.js"></script>
    <script>
        let shmPrice = null;

        async function fetchShmPrice() {
            try {
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=shardeum&vs_currencies=eur,usd,inr');
                const data = await response.json();
                shmPrice = data.shardeum || { eur: 0, usd: 0, inr: 0 };
                console.log('Fetched SHM price:', shmPrice);
                updateShmAmount();
            } catch (error) {
                console.error('Error fetching SHM price:', error);
                document.getElementById('shmAmount').textContent = 'Error fetching SHM price. Using default.';
                shmPrice = { eur: 0, usd: 0, inr: 0 };
            }
        }

        function updateShmAmount() {
            const amountInput = document.getElementById('amount').value;
            const currency = document.getElementById('currency').value;
            if (!shmPrice || !amountInput) {
                document.getElementById('shmAmount').textContent = 'SHM Amount: Enter amount and select currency';
                return;
            }
            const amount = parseFloat(amountInput);
            const shmAmount = amount / shmPrice[currency.toLowerCase()];
            document.getElementById('shmAmount').textContent = `SHM Amount: ${shmAmount.toFixed(4)} SHM`;
        }

        async function checkMetaMaskConnection() {
            console.log('Checking MetaMask connection on page load...');
            try {
                if (window.ethereum) {
                    console.log('MetaMask provider detected');
                    if (!window.web3 || !window.web3.utils) {
                        console.log('Initializing Web3...');
                        await window.initWeb3();
                    }
                    const account = await window.getAccount();
                    console.log('MetaMask connected on load:', account);
                    if (account) {
                        document.getElementById('userAddress').value = account;
                        await fetchShmPrice();
                        await populateGroupDropdown();
                    } else {
                        console.log('No account connected, waiting for user to connect MetaMask');
                        document.getElementById('expenseMessage').textContent = 'Please connect MetaMask to load groups.';
                    }
                } else {
                    console.log('MetaMask not detected');
                    document.getElementById('expenseMessage').textContent = 'MetaMask not detected. Please install MetaMask and refresh.';
                }
            } catch (error) {
                console.error('Error checking MetaMask connection:', error);
                document.getElementById('expenseMessage').textContent = 'Error checking MetaMask connection: ' + error.message + '. Please refresh and reconnect MetaMask.';
            }
        }

        async function populateGroupDropdown() {
            const groupSelect = document.getElementById('groupId');
            const groupCreationDiv = document.getElementById('groupCreation');
            const submitButton = document.getElementById('submitButton');
            const expenseMessage = document.getElementById('expenseMessage');
            groupSelect.innerHTML = '<option value="" disabled selected>Loading groups...</option>';
            if (!window.web3 || !window.web3.utils || !window.getContract() || !window.getAccount()) {
                console.error('Web3.js, contract, or account not initialized');
                groupSelect.innerHTML = '<option value="" disabled selected>Connect wallet first</option>';
                groupCreationDiv.style.display = 'none';
                submitButton.textContent = 'Add Expense';
                expenseMessage.textContent = 'Please connect MetaMask to view groups.';
                return;
            }
            try {
                const userAddress = await window.getAccount();
                console.log('Fetching groups for:', userAddress);
                document.getElementById('userAddress').value = userAddress;
                const groupIds = [];
                for (let i = 0; i < 50; i++) {
                    let attempts = 3;
                    while (attempts > 0) {
                        try {
                            const groupId = await window.getContract().methods.userGroups(userAddress, i).call();
                            console.log(`userGroups[${i}]:`, groupId);
                            if (parseInt(groupId) >= 0 && groupId !== "" && groupId !== "0") {
                                groupIds.push(groupId);
                            } else {
                                console.log(`Stopping at index ${i}: invalid groupId ${groupId}`);
                                attempts = 0; // Break loop on invalid groupId
                            }
                            break;
                        } catch (error) {
                            console.error(`Error fetching userGroups[${i}], attempt ${4 - attempts}:`, error);
                            attempts--;
                            if (attempts === 0) {
                                console.log(`Stopping at index ${i} after failed attempts`);
                                break;
                            }
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        }
                    }
                    if (attempts === 0) break;
                }
                console.log('Found group IDs:', groupIds);
                groupSelect.innerHTML = '<option value="" disabled selected>Select a group</option>';
                if (groupIds.length === 0) {
                    groupSelect.innerHTML += '<option value="create">Create a new group</option>';
                    groupCreationDiv.style.display = 'block';
                    submitButton.textContent = 'Create Group';
                    expenseMessage.textContent = 'No groups found. Create one to add expenses.';
                } else {
                    groupCreationDiv.style.display = 'none';
                    submitButton.textContent = 'Add Expense';
                    expenseMessage.textContent = '';
                    for (let groupId of groupIds) {
                        try {
                            const result = await window.getContract().methods.getGroup(groupId).call();
                            console.log(`Group ${groupId} result:`, result);
                            const name = result[0] || result.name || 'Unnamed Group';
                            const members = result[1] || result.members || [];
                            if (!members || !Array.isArray(members)) {
                                console.warn(`Group ${groupId} has invalid members array:`, members);
                                continue;
                            }
                            const option = document.createElement('option');
                            option.value = groupId;
                            option.textContent = `${name} (ID: ${groupId})`;
                            groupSelect.appendChild(option);
                        } catch (error) {
                            console.error(`Error fetching group ${groupId}:`, error);
                        }
                    }
                    const createOption = document.createElement('option');
                    createOption.value = 'create';
                    createOption.textContent = 'Create a new group';
                    groupSelect.appendChild(createOption);
                }
            } catch (error) {
                console.error('Error fetching groups:', error);
                groupSelect.innerHTML = '<option value="" disabled selected>Error loading groups</option><option value="create">Create a new group</option>';
                groupCreationDiv.style.display = 'block';
                submitButton.textContent = 'Create Group';
                expenseMessage.textContent = 'Error loading groups. Please create a new group.';
            }
            groupSelect.addEventListener('change', function() {
                groupCreationDiv.style.display = this.value === 'create' ? 'block' : 'none';
                submitButton.textContent = this.value === 'create' ? 'Create Group' : 'Add Expense';
            });
        }

        function addMemberField() {
            const memberInputs = document.getElementById('memberInputs');
            const memberCount = memberInputs.children.length;
            if (memberCount >= 10) {
                alert('Maximum 10 members allowed per group.');
                return;
            }
            const div = document.createElement('div');
            div.className = 'member-input';
            div.innerHTML = `
                <input type="text" class="member-name" placeholder="Member Name (e.g., Bob)">
                <input type="text" class="member-address" placeholder="e.g., 0x742d...">
                <button type="button" class="remove-member" onclick="removeMember(this)">Remove</button>
            `;
            memberInputs.appendChild(div);
            updateRemoveButtons();
        }

        function removeMember(button) {
            const memberInputs = document.getElementById('memberInputs');
            if (memberInputs.children.length > 2) {
                button.parentElement.remove();
                updateRemoveButtons();
            } else {
                alert('At least one additional member is required besides your address.');
            }
        }

        function updateRemoveButtons() {
            const memberInputs = document.getElementById('memberInputs');
            const removeButtons = document.getElementsByClassName('remove-member');
            for (let btn of removeButtons) {
                btn.style.display = memberInputs.children.length > 2 ? 'inline-block' : 'none';
            }
        }

        document.getElementById('expenseForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!window.web3 || !window.web3.utils || !window.getContract() || !window.getAccount()) {
                alert('Web3 not initialized or wallet not connected. Please ensure MetaMask is installed and connected.');
                return;
            }
            const groupId = document.getElementById('groupId').value;
            const expenseMessage = document.getElementById('expenseMessage');
            const submitButton = document.getElementById('submitButton');
            const groupCreationDiv = document.getElementById('groupCreation');
            if (groupId === 'create') {
                const groupName = document.getElementById('groupName').value;
                const memberInputs = document.getElementsByClassName('member-input');
                if (!groupName) {
                    expenseMessage.textContent = 'Please enter a group name.';
                    return;
                }
                try {
                    const members = [];
                    const newMemberNames = {};
                    Array.from(memberInputs).forEach(input => {
                        const address = input.querySelector('.member-address').value.trim().toLowerCase();
                        const name = input.querySelector('.member-name').value.trim();
                        if (window.web3.utils.isAddress(address) || address === (await window.getAccount()).toLowerCase()) {
                            members.push(address);
                            if (name) newMemberNames[address] = name;
                        }
                    });
                    console.log('Submitting members:', members);
                    console.log('Saving member names:', newMemberNames);
                    if (members.length < 2) {
                        expenseMessage.textContent = 'Please include at least two valid Ethereum addresses (including yours).';
                        return;
                    }
                    const userAddress = (await window.getAccount()).toLowerCase();
                    if (!members.includes(userAddress)) {
                        expenseMessage.textContent = 'Your address is missing from the member list.';
                        return;
                    }
                    const existingNames = JSON.parse(localStorage.getItem('memberNames') || '{}');
                    localStorage.setItem('memberNames', JSON.stringify({ ...existingNames, ...newMemberNames }));
                    const tx = await window.getContract().methods.createGroup(groupName, members).send({
                        from: await window.getAccount(),
                        value: '0',
                        type: '0x0'
                    });
                    expenseMessage.textContent = `Group created! Transaction: https://explorer-unstable.shardeum.org/tx/${tx.transactionHash}`;
                    groupCreationDiv.style.display = 'none';
                    submitButton.textContent = 'Add Expense';
                    this.reset();
                    await populateGroupDropdown();
                    const groupCount = await window.getContract().methods.groupCount().call();
                    document.getElementById('groupId').value = parseInt(groupCount) - 1;
                    return;
                } catch (error) {
                    console.error('Group creation error:', error);
                    expenseMessage.textContent = 'Error: ' + (error.message.includes('Eip1559NotSupportedError') ? 'Network does not support EIP-1559. Try again.' : error.message.includes('revert') ? 'Invalid input or contract revert. Check addresses and try again.' : error.message);
                    return;
                }
            }
            if (!groupId) {
                expenseMessage.textContent = 'Please select a group.';
                return;
            }
            const description = document.getElementById('description').value;
            const amountInput = document.getElementById('amount').value;
            const currency = document.getElementById('currency').value;
            let amount;
            try {
                const shmAmount = parseFloat(amountInput) / shmPrice[currency.toLowerCase()];
                amount = window.web3.utils.toWei(shmAmount.toString(), 'ether');
            } catch (error) {
                expenseMessage.textContent = 'Invalid amount format or SHM price not loaded. Please try again.';
                return;
            }
            const splitType = document.getElementById('split').value;
            let customShares = [];
            if (splitType === 'custom') {
                try {
                    customShares = document.getElementById('customShares').value.split(',').map(s => parseInt(s.trim()));
                    const total = customShares.reduce((sum, val) => sum + val, 0);
                    if (total !== 100) {
                        expenseMessage.textContent = 'Custom shares must sum to 100%';
                        return;
                    }
                    const [_, members] = await window.getContract().methods.getGroup(groupId).call();
                    if (customShares.length !== members.length) {
                        expenseMessage.textContent = `Custom shares count (${customShares.length}) must match group members (${members.length}).`;
                        return;
                    }
                } catch (error) {
                    expenseMessage.textContent = 'Invalid custom shares format. Use comma-separated percentages (e.g., 40,30,30).';
                    return;
                }
            }
            try {
                const tx = await window.getContract().methods.addExpense(groupId, description, amount, splitType, customShares).send({
                    from: await window.getAccount(),
                    value: '0',
                    type: '0x0'
                });
                expenseMessage.textContent = `Expense added! Transaction: https://explorer-unstable.shardeum.org/tx/${tx.transactionHash}`;
                this.reset();
                document.getElementById('customShares').style.display = 'none';
                document.getElementById('customLabel').style.display = 'none';
                await populateGroupDropdown();
            } catch (error) {
                console.error('Expense error:', error);
                expenseMessage.textContent = 'Error: ' + (error.message.includes('Eip1559NotSupportedError') ? 'Network does not support EIP-1559. Try again.' : error.message.includes('revert') ? 'Invalid input or contract revert. Check group ID and try again.' : error.message);
            }
        });

        const splitSelect = document.getElementById('split');
        const customInput = document.getElementById('customShares');
        const customLabel = document.getElementById('customLabel');
        splitSelect.addEventListener('change', function() {
            const show = this.value === 'custom';
            customInput.style.display = show ? 'block' : 'none';
            customLabel.style.display = show ? 'block' : 'none';
        });

        document.getElementById('amount').addEventListener('input', updateShmAmount);
        document.getElementById('currency').addEventListener('change', updateShmAmount);
    </script>
</body>
</html>