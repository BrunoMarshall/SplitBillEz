<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Expense - SplitBillEz</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" href="images/splitbillez_favicon.png">
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
</head>
<body onload="initWeb3().then(populateGroupDropdown)">
    <header>
        <div class="header-container">
            <img src="images/splitbillez_logo.png" alt="SplitBillEz Logo" class="logo">
            <nav>
                <a href="index.html">Home</a>
                <a href="dashboard.html">Dashboard</a>
                <a href="add-expense.html">Add Expense</a>
            </nav>
            <button class="metamask-button" onclick="initWeb3().then(populateGroupDropdown)">Connect with MetaMask</button>
        </div>
    </header>
    <main>
        <section>
            <h2>Add a New Expense</h2>
            <div id="groupCreation" style="display:none;">
                <h3>Create a New Group</h3>
                <form id="groupForm">
                    <label for="groupName">Group Name:</label>
                    <input type="text" id="groupName" placeholder="e.g., Trip to Goa" required>
                    <label for="members">Member Addresses (comma-separated):</label>
                    <input type="text" id="members" placeholder="e.g., 0xEa60...,0x742d..." required>
                    <button type="submit">Create Group</button>
                </form>
                <p id="groupMessage"></p>
            </div>
            <form id="expenseForm">
                <label for="groupId">Group:</label>
                <select id="groupId" required>
                    <option value="" disabled selected>Select a group</option>
                </select>
                <button type="button" id="createGroupBtn" onclick="showGroupCreation()">Create New Group</button>
                <label for="description">Description:</label>
                <input type="text" id="description" placeholder="e.g., Dinner at Restaurant" required>
                <label for="amount">Amount (SHM):</label>
                <input type="number" id="amount" placeholder="e.g., 100" step="0.01" required>
                <label for="split">Split Type:</label>
                <select id="split" required>
                    <option value="equal">Equal</option>
                    <option value="custom">Custom (% shares, sum to 100)</option>
                </select>
                <label for="customShares" id="customLabel" style="display:none;">Custom Shares (%, comma-separated):</label>
                <input type="text" id="customShares" placeholder="e.g., 40,30,30" style="display:none;">
                <button type="submit">Add Expense</button>
            </form>
        </section>
    </main>
    <footer>
        <p>Â© 2025 SplitBillEz Powered by Shardeum</p>
        <div class="social-links">
            <a href="https://discord.com/invite/shardeum" target="_blank" rel="nofollow">
                <img src="images/discord.svg" alt="Discord" class="social-icon">
            </a>
            <a href="https://github.com/BrunoMarshall/SplitBillEz" target="_blank" rel="nofollow">
                <img src="images/github.svg" alt="GitHub" class="social-icon">
            </a>
            <a href="https://www.linkedin.com/company/shardeum/" target="_blank" rel="nofollow">
                <img src="images/linkedin.svg" alt="LinkedIn" class="social-icon">
            </a>
            <a href="https://t.me/shardeum" target="_blank" rel="nofollow">
                <img src="images/telegram.svg" alt="Telegram" class="social-icon">
            </a>
            <a href="https://x.com/shardeum" target="_blank" rel="nofollow">
                <img src="images/twitter.svg" alt="X" class="social-icon">
            </a>
            <a href="https://www.youtube.com/@shardeum" target="_blank" rel="nofollow">
                <img src="images/youtube.svg" alt="YouTube" class="social-icon">
            </a>
        </div>
    </footer>
    <script src="js/app.js"></script>
    <script>
        async function populateGroupDropdown() {
            const groupSelect = document.getElementById('groupId');
            const groupCreationDiv = document.getElementById('groupCreation');
            const createGroupBtn = document.getElementById('createGroupBtn');
            groupSelect.innerHTML = '<option value="" disabled selected>Loading groups...</option>';
            if (!window.getContract() || !window.getAccount()) {
                groupSelect.innerHTML = '<option value="" disabled selected>Connect wallet first</option>';
                groupCreationDiv.style.display = 'none';
                createGroupBtn.style.display = 'block';
                return;
            }
            try {
                const userAddress = window.getAccount();
                const groupIds = [];
                // Iterate to fetch userGroups entries
                for (let i = 0; i < 50; i++) { // Reduced limit for efficiency
                    try {
                        const groupId = await window.getContract().methods.userGroups(userAddress, i).call();
                        if (parseInt(groupId) >= 0 && groupId !== "") {
                            groupIds.push(groupId);
                        } else {
                            break;
                        }
                    } catch {
                        break; // Stop on error (index out of bounds)
                    }
                }
                if (groupIds.length === 0) {
                    groupSelect.innerHTML = '<option value="" disabled selected>No groups found</option>';
                    groupCreationDiv.style.display = 'block';
                    createGroupBtn.style.display = 'block';
                    return;
                }
                groupSelect.innerHTML = '<option value="" disabled selected>Select a group</option>';
                groupCreationDiv.style.display = 'none';
                createGroupBtn.style.display = 'block';
                for (let groupId of groupIds) {
                    try {
                        const [name] = await window.getContract().methods.getGroup(groupId).call();
                        const option = document.createElement('option');
                        option.value = groupId;
                        option.textContent = `${name} (ID: ${groupId})`;
                        groupSelect.appendChild(option);
                    } catch (error) {
                        console.error(`Error fetching group ${groupId}:`, error);
                    }
                }
            } catch (error) {
                console.error('Error fetching groups:', error);
                groupSelect.innerHTML = '<option value="" disabled selected>Error loading groups</option>';
                groupCreationDiv.style.display = 'block';
                createGroupBtn.style.display = 'block';
            }
        }

        function showGroupCreation() {
            document.getElementById('groupCreation').style.display = 'block';
            document.getElementById('createGroupBtn').style.display = 'none';
        }

        document.getElementById('groupForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!window.web3() || !window.getContract() || !window.getAccount()) {
                alert('Please connect MetaMask first.');
                return;
            }
            const groupName = document.getElementById('groupName').value;
            const membersInput = document.getElementById('members').value;
            const groupMessage = document.getElementById('groupMessage');
            try {
                const members = membersInput.split(',').map(addr => addr.trim()).filter(addr => addr.match(/^0x[a-fA-F0-9]{40}$/));
                if (members.length < 2) {
                    groupMessage.textContent = 'Please enter at least two valid Ethereum addresses.';
                    return;
                }
                if (!members.includes(window.getAccount())) {
                    groupMessage.textContent = 'You must include your own address in the group.';
                    return;
                }
                const tx = await window.getContract().methods.createGroup(groupName, members).send({ from: window.getAccount(), value: '0' });
                groupMessage.textContent = `Group created! Transaction: https://explorer-unstable.shardeum.org/tx/${tx.transactionHash}`;
                this.reset();
                document.getElementById('groupCreation').style.display = 'none';
                await populateGroupDropdown(); // Refresh dropdown
            } catch (error) {
                groupMessage.textContent = 'Error: ' + error.message;
            }
        });

        const splitSelect = document.getElementById('split');
        const customInput = document.getElementById('customShares');
        const customLabel = document.getElementById('customLabel');
        splitSelect.addEventListener('change', function() {
            const show = this.value === 'custom';
            customInput.style.display = show ? 'block' : 'none';
            customLabel.style.display = show ? 'block' : 'none';
        });

        document.getElementById('expenseForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!window.web3() || !window.getContract() || !window.getAccount()) {
                alert('Web3 not initialized or wallet not connected. Please ensure MetaMask is installed and connected.');
                return;
            }
            const groupId = document.getElementById('groupId').value;
            if (!groupId) {
                alert('Please select a group.');
                return;
            }
            const description = document.getElementById('description').value;
            const amountInput = document.getElementById('amount').value;
            let amount;
            try {
                amount = window.web3().utils.toWei(amountInput, 'ether');
            } catch (error) {
                alert('Invalid amount format. Please enter a valid number.');
                return;
            }
            const splitType = document.getElementById('split').value;
            let customShares = [];
            if (splitType === 'custom') {
                try {
                    customShares = document.getElementById('customShares').value.split(',').map(s => parseInt(s.trim()));
                    const total = customShares.reduce((sum, val) => sum + val, 0);
                    if (total !== 100) {
                        alert('Custom shares must sum to 100%');
                        return;
                    }
                    const [_, members] = await window.getContract().methods.getGroup(groupId).call();
                    if (customShares.length !== members.length) {
                        alert(`Custom shares count (${customShares.length}) must match group members (${members.length}).`);
                        return;
                    }
                } catch (error) {
                    alert('Invalid custom shares format. Use comma-separated percentages (e.g., 40,30,30).');
                    return;
                }
            }
            try {
                const tx = await window.getContract().methods.addExpense(groupId, description, amount, splitType, customShares).send({ from: window.getAccount(), value: '0' });
                alert(`Expense added! Transaction: https://explorer-unstable.shardeum.org/tx/${tx.transactionHash}`);
                this.reset();
                customInput.style.display = 'none';
                customLabel.style.display = 'none';
                await populateGroupDropdown();
            } catch (error) {
                alert('Error: ' + error.message + '\nEnsure you are a group member and have enough SHM for gas.');
            }
        });
    </script>
</body>
</html>