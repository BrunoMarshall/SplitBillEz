<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - SplitBillEz</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" href="images/splitbillez_favicon.png">
    <script src="https://cdn.jsdelivr.net/npm/web3@4.16.0/dist/web3.min.js"></script>
    <script src="js/app.js"></script>
</head>
<body>
    <header>
        <div class="header-container">
            <img src="images/splitbillez_logo.png" alt="SplitBillEz Logo" class="logo">
            <nav>
                <a href="index.html">Home</a>
                <a href="dashboard.html">Dashboard</a>
                <a href="add-expense.html">Add Expense</a>
            </nav>
            <button class="metamask-button" onclick="handleMetaMaskToggle().then(() => populateDashboard())">Connect with MetaMask</button>
        </div>
    </header>
    <main>
        <section>
            <h2>Your Groups</h2>
            <div id="dashboardContent">
                <p>Connect MetaMask to load groups...</p>
            </div>
        </section>
    </main>
    <footer>
        <p>Â© 2025 SplitBillEz Powered by Shardeum</p>
        <div class="social-links">
            <a href="https://discord.com/invite/shardeum" target="_blank" rel="nofollow">
                <img src="images/discord.svg" alt="Discord" class="social-icon">
            </a>
            <a href="https://github.com/BrunoMarshall/SplitBillEz" target="_blank" rel="nofollow">
                <img src="images/github.svg" alt="GitHub" class="social-icon">
            </a>
            <a href="https://www.linkedin.com/company/shardeum/" target="_blank" rel="nofollow">
                <img src="images/linkedin.svg" alt="LinkedIn" class="social-icon">
            </a>
            <a href="https://t.me/shardeum" target="_blank" rel="nofollow">
                <img src="images/telegram.svg" alt="Telegram" class="social-icon">
            </a>
            <a href="https://x.com/shardeum" target="_blank" rel="nofollow">
                <img src="images/twitter.svg" alt="X" class="social-icon">
            </a>
            <a href="https://www.youtube.com/@shardeum" target="_blank" rel="nofollow">
                <img src="images/youtube.svg" alt="YouTube" class="social-icon">
            </a>
        </div>
    </footer>
    <script>
        // Manual Blockies implementation
        function createGroupAvatar(groupId) {
            try {
                const seed = String(groupId);
                const canvas = document.createElement('canvas');
                canvas.width = 32;
                canvas.height = 32;
                const ctx = canvas.getContext('2d');

                // Simple hash for deterministic colors
                let hash = 0;
                for (let i = 0; i < seed.length; i++) {
                    hash = seed.charCodeAt(i) + ((hash << 5) - hash);
                }

                // Generate colors (RGB)
                const colors = [
                    `rgb(${(hash & 0xff0000) >> 16}, ${(hash & 0x00ff00) >> 8}, ${hash & 0x0000ff})`,
                    `rgb(${((hash >> 8) & 0xff0000) >> 16}, ${((hash >> 8) & 0x00ff00) >> 8}, ${(hash >> 8) & 0x0000ff})`
                ];

                // Draw 8x8 grid
                const size = 4; // 32px / 8 = 4px per block
                for (let x = 0; x < 8; x++) {
                    for (let y = 0; y < 8; y++) {
                        ctx.fillStyle = colors[(x * y + hash) % 2];
                        ctx.fillRect(x * size, y * size, size, size);
                    }
                }
                return canvas.toDataURL();
            } catch (error) {
                console.error('Error generating group avatar for groupId ' + groupId + ':', error);
                const canvas = document.createElement('canvas');
                canvas.width = 32;
                canvas.height = 32;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#ccc';
                ctx.fillRect(0, 0, 32, 32);
                return canvas.toDataURL();
            }
        }

        function truncateAddress(address) {
            if (!address || typeof address !== 'string' || address.length < 10) return 'Unknown';
            return `${address.slice(0, 6)}...${address.slice(-4)}`;
        }

        function getMemberName(address) {
            const memberNames = JSON.parse(localStorage.getItem('memberNames') || '{}');
            return memberNames[address.toLowerCase()] || truncateAddress(address);
        }

        function getInitials(name) {
            if (!name || name === 'Unknown') return '?';
            if (name.startsWith('0x')) return '0';
            return name.charAt(0).toUpperCase();
        }

        function createInitialsAvatar(name) {
            const canvas = document.createElement('canvas');
            canvas.width = 32;
            canvas.height = 32;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#007bff';
            ctx.beginPath();
            ctx.arc(16, 16, 16, 0, 2 * Math.PI);
            ctx.fill();
            ctx.fillStyle = '#fff';
            ctx.font = '16px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(getInitials(name), 16, 16);
            return canvas.toDataURL();
        }

        async function populateDashboard() {
            const dashboardContent = document.getElementById('dashboardContent');
            dashboardContent.innerHTML = '<p>Loading groups...</p>';

            if (!window.web3 || !window.web3.utils) {
                console.error('Web3.js or web3.utils is not initialized');
                try {
                    await initWeb3();
                } catch (error) {
                    console.error('Web3 reinitialization failed:', error);
                    dashboardContent.innerHTML = '<p>Error: Web3.js failed to initialize. Please refresh and reconnect MetaMask.</p>';
                    return;
                }
            }

            if (!window.web3 || !window.web3.utils) {
                console.error('Web3.js or web3.utils still not initialized after retry');
                dashboardContent.innerHTML = '<p>Error: Web3.js not properly initialized. Please refresh and reconnect MetaMask.</p>';
                return;
            }

            if (!window.getContract() || !window.getAccount()) {
                console.error('Contract or account not initialized');
                dashboardContent.innerHTML = '<p>Please connect MetaMask to view your groups.</p>';
                return;
            }

            try {
                const userAddress = await window.getAccount();
                console.log('Fetching groups for dashboard:', userAddress);
                const groupIds = [];
                for (let i = 0; i < 50; i++) {
                    let attempts = 3;
                    while (attempts > 0) {
                        try {
                            const groupId = await window.getContract().methods.userGroups(userAddress, i).call();
                            console.log(`userGroups[${i}]:`, groupId);
                            if (parseInt(groupId) >= 0 && groupId !== "" && groupId !== "0") {
                                groupIds.push(groupId);
                            }
                            break;
                        } catch (error) {
                            console.error(`Error fetching userGroups[${i}], attempt ${4 - attempts}:`, error);
                            attempts--;
                            if (attempts === 0) break;
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        }
                    }
                    if (attempts === 0) break;
                }
                console.log('Dashboard group IDs:', groupIds);
                if (groupIds.length === 0) {
                    dashboardContent.innerHTML = '<p>No groups found. Create one in the Add Expense page.</p>';
                    return;
                }
                dashboardContent.innerHTML = '';

                // Fetch ExpenseAdded events
                let expenses = [];
                try {
                    const events = await window.getContract().getPastEvents('ExpenseAdded', {
                        fromBlock: 0,
                        toBlock: 'latest'
                    });
                    console.log('ExpenseAdded events:', events);
                    expenses = events.map(event => ({
                        id: event.returnValues.expenseId,
                        groupId: String(event.returnValues.groupId).trim(),
                        description: event.returnValues.description || 'No description',
                        amount: event.returnValues.amount ? window.web3.utils.fromWei(event.returnValues.amount, 'ether') : '0',
                        // Payer and splitType not in event, fetch from expenses mapping
                        payer: null,
                        splitType: null,
                        timestamp: null
                    }));

                    // Fetch additional expense details
                    for (let expense of expenses) {
                        try {
                            const expenseData = await window.getContract().methods.expenses(expense.id).call();
                            console.log(`Expense ${expense.id} raw data:`, expenseData);
                            expense.payer = expenseData.payer || 'Unknown';
                            expense.splitType = expenseData.splitType || 'Unknown';
                            expense.timestamp = expenseData.timestamp && parseInt(expenseData.timestamp) > 0
                                ? new Date(parseInt(expenseData.timestamp) * 1000).toLocaleString()
                                : 'N/A';
                        } catch (error) {
                            console.error(`Error fetching expense ${expense.id} details:`, error);
                        }
                    }
                } catch (error) {
                    console.error('Error fetching ExpenseAdded events:', error);
                    expenses = [];
                }
                console.log('Processed expenses:', expenses);

                for (let groupId of groupIds) {
                    try {
                        const result = await window.getContract().methods.getGroup(groupId).call();
                        console.log(`Group ${groupId} result:`, result);
                        const name = result[0] || result.name || 'Unnamed Group';
                        const members = result[1] || result.members || [];
                        if (!members || !Array.isArray(members)) {
                            console.warn(`Group ${groupId} has invalid members array:`, members);
                            continue;
                        }
                        let balMembers = [], balances = [];
                        try {
                            const balanceData = await window.getContract().methods.getGroupBalances(groupId).call();
                            balMembers = balanceData[0] || balanceData.members || [];
                            balances = balanceData[1] || balanceData.balances || [];
                            console.log(`Group ${groupId} balances:`, { balMembers, balances });
                        } catch (error) {
                            console.error(`Error fetching balances for group ${groupId}:`, error);
                            balances = [];
                            balMembers = [];
                        }

                        // Filter expenses for this group
                        const groupExpenses = expenses.filter(exp => exp.groupId === String(groupId).trim());
                        console.log(`Group ${groupId} expenses:`, groupExpenses);

                        const groupAvatar = createGroupAvatar(groupId);
                        const groupDiv = document.createElement('div');
                        groupDiv.className = 'group';
                        groupDiv.innerHTML = `
                            <h3><img src="${groupAvatar}" class="group-avatar" alt="Group Avatar"> ${name} (ID: ${groupId})</h3>
                            <p><strong>Members:</strong> ${members.map(addr => `
                                <span class="member"><img src="${createInitialsAvatar(getMemberName(addr))}" class="user-avatar" alt="User Avatar"> ${getMemberName(addr)}</span>
                            `).join(', ')}</p>
                            <h4>Expenses:</h4>
                            ${groupExpenses.length > 0 ? groupExpenses.map(exp => `
                                <p>Expense ${exp.id}: ${exp.description} - ${exp.amount} SHM 
                                (Payer: <span class="member"><img src="${createInitialsAvatar(getMemberName(exp.payer))}" class="user-avatar" alt="User Avatar"> ${getMemberName(exp.payer)}</span>, 
                                Split: ${exp.splitType || 'Unknown'}, Date: ${exp.timestamp || 'N/A'})</p>
                            `).join('') : '<p>No expenses found. ${expenses.length > 0 ? "Possible contract issue: check ExpenseAdded events." : ""}</p>'}
                            <h4>Balances:</h4>
                            ${balMembers.length > 0 ? balMembers.map((addr, i) => `
                                <p><span class="member"><img src="${createInitialsAvatar(getMemberName(addr))}" class="user-avatar" alt="User Avatar"> ${getMemberName(addr)}</span>: 
                                ${balances[i] ? parseFloat(window.web3.utils.fromWei(balances[i], 'ether')).toFixed(2) : '0.00'} SHM</p>
                            `).join('') : '<p>No balances available.</p>'}
                            <h4>Settle Debt</h4>
                            <form id="settleDebtForm-${groupId}" class="settle-debt-form">
                                <input type="hidden" name="groupId" value="${groupId}">
                                <label for="settleTo-${groupId}">Pay To:</label>
                                <select id="settleTo-${groupId}" required>
                                    <option value="" disabled selected>Select a member</option>
                                    ${members
                                        .filter(addr => addr.toLowerCase() !== userAddress.toLowerCase())
                                        .map(addr => `<option value="${addr}">${getMemberName(addr)}</option>`)
                                        .join('')}
                                </select>
                                <label for="settleAmount-${groupId}">Amount (SHM):</label>
                                <input type="number" id="settleAmount-${groupId}" placeholder="e.g., 10" step="0.01" required>
                                <button type="submit" class="submit-group">Settle Debt</button>
                            </form>
                            <p id="settleMessage-${groupId}"></p>
                        `;
                        dashboardContent.appendChild(groupDiv);
                        document.getElementById(`settleDebtForm-${groupId}`).addEventListener('submit', async function(e) {
                            e.preventDefault();
                            if (!window.web3 || !window.getContract() || !window.getAccount()) {
                                alert('Please connect MetaMask first.');
                                return;
                            }
                            const settleGroupId = groupId;
                            const toAddress = document.getElementById(`settleTo-${groupId}`).value;
                            const amountInput = document.getElementById(`settleAmount-${groupId}`).value;
                            const settleMessage = document.getElementById(`settleMessage-${groupId}`);
                            let amount;
                            try {
                                amount = window.web3.utils.toWei(amountInput, 'ether');
                            } catch (error) {
                                settleMessage.textContent = 'Invalid amount format. Please enter a valid number.';
                                return;
                            }
                            try {
                                const tx = await window.getContract().methods.settleDebt(settleGroupId, toAddress, amount).send({
                                    from: await window.getAccount(),
                                    value: '0',
                                    type: '0x0'
                                });
                                settleMessage.textContent = `Debt settled! Transaction: https://explorer-unstable.shardeum.org/tx/${tx.transactionHash}`;
                                this.reset();
                                await populateDashboard();
                            } catch (error) {
                                console.error(`Debt settlement error for group ${settleGroupId}:`, error);
                                settleMessage.textContent = 'Error: ' + (error.message.includes('Eip1559NotSupportedError') ? 'Network does not support EIP-1559. Try again.' : error.message.includes('revert') ? 'Invalid input or contract revert. Check inputs and try again.' : error.message);
                            }
                        });
                    } catch (error) {
                        console.error(`Error processing group ${groupId}:`, error);
                    }
                }
            } catch (error) {
                console.error('Error populating dashboard:', error);
                dashboardContent.innerHTML = '<p>Error loading groups: ' + error.message + '. Please try again.</p>';
            }
        }
    </script>
</body>
</html>